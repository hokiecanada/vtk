<p id="notice"><%= notice %></p>

<div id="filters">
	<%= form_tag search_systems_path, :method => :post do %>
		<input type="hidden" name="filter_tasks[]"> 
		<input type="hidden" name="filter_comps[]"> 
		<input type="hidden" name="filter_metrics[]">
		<input type="hidden" name="filter_display_as" id="filter_display_as" value="<%= @display_as %>">
		<%= hidden_field_tag "search_systems", @search_systems %>
	
		<h3>Filter by:</h3>
		<div id="filter_comps_hidden">
			<%= link_to '[+]', "#", :onclick => "Effect.BlindDown('filter_comps_list');Element.show('filter_comps_expanded');Element.hide('filter_comps_hidden');", :remote => true %> Component of Immersion<br>
		</div>
		<div id="filter_comps_expanded" style="display:none">
			<%= link_to '[-]', "#", :onclick => "Effect.BlindUp('filter_comps_list');Element.show('filter_comps_hidden');Element.hide('filter_comps_expanded');", :remote => true %> Component of Immersion<br>
		</div>
		<div id="filter_comps_list" style="display:none">
			<% @comps.each do |comp| %>
				<%= check_box_tag "filter_comps[]", comp.id, @filter_comps.include?(comp) %><%= comp.comp_tag %><br>
			<% end %>
		</div>
		<div id="filter_tasks_hidden">
			<%= link_to '[+]', "#", :onclick => "Effect.BlindDown('filter_tasks_list');Element.show('filter_tasks_expanded');Element.hide('filter_tasks_hidden');", :remote => true %> Task<br>
		</div>
		<div id="filter_tasks_expanded" style="display:none">
			<%= link_to '[-]', "#", :onclick => "Effect.BlindUp('filter_tasks_list');Element.show('filter_tasks_hidden');Element.hide('filter_tasks_expanded');", :remote => true %> Task<br>
		</div>
		<div id="filter_tasks_list" style="display:none">
			<% @tasks.each do |task| %>
				<%= check_box_tag "filter_tasks[]", task.id, @filter_tasks.include?(task) %><%= task.task_tag %><br>
			<% end %>
		</div>
		<div id="filter_metrics_hidden">
			<%= link_to '[+]', "#", :onclick => "Effect.BlindDown('filter_metrics_list');Element.show('filter_metrics_expanded');Element.hide('filter_metrics_hidden');", :remote => true %> Metrics<br>
		</div>
		<div id="filter_metrics_expanded" style="display:none">
			<%= link_to '[-]', "#", :onclick => "Effect.BlindUp('filter_metrics_list');Element.show('filter_metrics_hidden');Element.hide('filter_metrics_expanded');", :remote => true %> Metrics<br>
		</div>
		<div id="filter_metrics_list" style="display:none">
			<% @metrics.each do |metric| %>
				<%= check_box_tag "filter_metrics[]", metric.id, @filter_metrics.include?(metric) %><%= metric.metric_tag %><br>
			<% end %>
		</div>
		<%= submit_tag "Filter Results", :name => nil %>
	<% end %>
</div>

<div id="content">		
	<div id="search_options">
		<h1>Search the Knowledgebase:</h1>

		<div id="search_type">
			Search by: <%= select_tag "search_option", options_for_select(["Component of immersion","Task","Metric","System"],"System"), html_options = {:onchange => "search_type(this.value)"} %>
		</div>

		<div id="metric">
			<%= form_tag search_systems_path, :method => :post do %>
				<input type="hidden" name="search_systems[]">
				<% @filter_tasks.each do |f_t| %>
					<input type="hidden" name="filter_tasks[]" value="<%= f_t.id %>">
				<% end %>
				<% @filter_comps.each do |f_c| %>
					<input type="hidden" name="filter_comps[]" value="<%= f_c.id %>">
				<% end %>
				<% @filter_metrics.each do |f_m| %>
					<input type="hidden" name="filter_metrics[]" value="<%= f_m.id %>">
				<% end %>
				<input type="hidden" name="system_display_as" id="system_display_as" value="<%= @display_as %>">

				<table>
					<% @systems.each_with_index do |system,i| %>
						<% if i%3 == 0 %>
							<tr><td style="padding:0px 10px 0px 0px"><%= check_box_tag "search_systems[]", system.id, @search_systems.include?(system.id.to_s()) %><b><%= system.system_tag %></b>
							<small><i>(<%= Finding.joins(:systems).where(:systems => {:id => system.id}).count() %> findings, 
								<%= Experiment.joins(:systems).where(:systems => {:id => system.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:systems).where(:systems => {:id => system.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% elsif i%3 == 1 %>
							<td style="padding:0px 10px 0px 10px"><%= check_box_tag "search_systems[]", system.id, @search_systems.include?(system.id.to_s()) %><b><%= system.system_tag %></b>
							<small><i>(<%= Finding.joins(:systems).where(:systems => {:id => system.id}).count() %> findings, 
								<%= Experiment.joins(:systems).where(:systems => {:id => system.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:systems).where(:systems => {:id => system.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% else %>
							<td style="padding:0px 0px 0px 10px"><%= check_box_tag "search_systems[]", system.id, @search_systems.include?(system.id.to_s()) %><b><%= system.system_tag %></b>
							<small><i>(<%= Finding.joins(:systems).where(:systems => {:id => system.id}).count() %> findings, 
								<%= Experiment.joins(:systems).where(:systems => {:id => system.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:systems).where(:systems => {:id => system.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td></tr>
						<% end %>
					<% end %>
					<tr><td colspan="3" align="right"><%= submit_tag "Search", :name => nil %></td></tr>
				</table>
			<% end %>
		</div>

		<div id="comp" style="display:none">		
			<%= form_tag search_comps_path, :method => :post do %>
				<input type="hidden" name="search_comps[]">
				<input type="hidden" name="comp_display_as" id="comp_display_as" value="<%= @display_as %>">
				
				<table>
					<% @comps.each_with_index do |comp,i| %>
						<% if i%3 == 0 %>
							<tr><td style="padding:0px 10px 0px 0px"><b><%= check_box_tag "search_comps[]", comp.id, false %><%= comp.comp_tag %></b>
							<small><i>(<%= Finding.joins(:comps).where(:comps => {:id => comp.id}).count() %> findings, 
								<%= Experiment.joins(:comps).where(:comps => {:id => comp.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:comps).where(:comps => {:id => comp.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% elsif i%3 == 1 %>
							<td style="padding:0px 10px 0px 10px"><b><%= check_box_tag "search_comps[]", comp.id, false %><%= comp.comp_tag %></b>
							<small><i>(<%= Finding.joins(:comps).where(:comps => {:id => comp.id}).count() %> findings, 
								<%= Experiment.joins(:comps).where(:comps => {:id => comp.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:comps).where(:comps => {:id => comp.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% else %>
							<td style="padding:0px 0px 0px 10px"><b><%= check_box_tag "search_comps[]", comp.id, false %><%= comp.comp_tag %></b>
							<small><i>(<%= Finding.joins(:comps).where(:comps => {:id => comp.id}).count() %> findings, 
								<%= Experiment.joins(:comps).where(:comps => {:id => comp.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:comps).where(:comps => {:id => comp.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td></tr>
						<% end %>
					<% end %>
					<tr><td colspan="3" align="right"><%= submit_tag "Search", :name => nil %></td></tr>
				</table>
			<% end %>
		</div>
			
		<div id="task" style="display:none">
			<%= form_tag search_tasks_path, :method => :post do %>
				<input type="hidden" name="search_tasks[]">
				<input type="hidden" name="task_display_as" id="task_display_as" value="<%= @display_as %>">
				
				<table>
					<% @tasks.each_with_index do |task,i| %>
						<% if i%3 == 0 %>
							<tr><td style="padding:0px 10px 0px 0px"><%= check_box_tag "search_tasks[]", task.id, false %><b><%= task.task_tag %></b>
							<small><i>(<%= Finding.joins(:tasks).where(:tasks => {:id => task.id}).count() %> findings, 
								<%= Experiment.joins(:tasks).where(:tasks => {:id => task.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:tasks).where(:tasks => {:id => task.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% elsif i%3 == 1 %>
							<td style="padding:0px 10px 0px 10px"><%= check_box_tag "search_tasks[]", task.id, false %><b><%= task.task_tag %></b>
							<small><i>(<%= Finding.joins(:tasks).where(:tasks => {:id => task.id}).count() %> findings, 
								<%= Experiment.joins(:tasks).where(:tasks => {:id => task.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:tasks).where(:tasks => {:id => task.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% else %>
							<td style="padding:0px 0px 0px 10px"><%= check_box_tag "search_tasks[]", task.id, false %><b><%= task.task_tag %></b>
							<small><i>(<%= Finding.joins(:tasks).where(:tasks => {:id => task.id}).count() %> findings, 
								<%= Experiment.joins(:tasks).where(:tasks => {:id => task.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:tasks).where(:tasks => {:id => task.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td></tr>
						<% end %>
					<% end %>
					<tr><td colspan="3" align="right"><%= submit_tag "Search", :name => nil %></td></tr>
				</table>
			<% end %>
		</div>

		<div id="metric" style="display:none">	
			<%= form_tag search_metrics_path, :method => :post do %>
				<input type="hidden" name="search_metrics[]"> 
				<input type="hidden" name="metric_display_as" id="metric_display_as" value="<%= @display_as %>">
				
				<table>
					<% @metrics.each_with_index do |metric,i| %>
						<% if i%3 == 0 %>
							<tr><td style="padding:0px 10px 0px 0px"><%= check_box_tag "search_metrics[]", metric.id, false %><b><%= metric.metric_tag %></b>
							<small><i>(<%= Finding.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> findings, 
								<%= Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% elsif i%3 == 1 %>
							<td style="padding:0px 10px 0px 10px"><%= check_box_tag "search_metrics[]", metric.id, false %><b><%= metric.metric_tag %></b>
							<small><i>(<%= Finding.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> findings, 
								<%= Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td>
						<% else %>
							<td style="padding:0px 0px 0px 10px"><%= check_box_tag "search_metrics[]", metric.id, false %><b><%= metric.metric_tag %></b>
							<small><i>(<%= Finding.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> findings, 
								<%= Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).count() %> experiments, 
								<%= Paper.where(:id => Experiment.joins(:metrics).where(:metrics => {:id => metric.id}).collect!{|x| x.paper_id}).count() %> papers)
							</i></small></td></tr>
						<% end %>
					<% end %>
					<tr><td colspan="3" align="right"><%= submit_tag "Search", :name => nil %></td></tr>
				</table>
			<% end %>
		</div>	
	</div>	

	<div id="search_results">
		<div id="search_findings" style="display:<% if @display_as == 'Findings' %>inline<% else %>none<% end %>">
			<center><small>Display results as:</small><br>
			Findings | <%= link_to 'Experiments', "#", :onclick => "search_results_display_as('experiments')" %> | <%= link_to 'Papers', "#", :onclick => "search_results_display_as('papers')" %></center>
			<h1>Results:</h1>
			
			<table cellspacing="0" cellpadding="0">
				<tr><th style="width:15%">Experiment Type</th>
				<th style="width:15%">Year</th>
				<th style="width:70%">Details</th></tr>
				<% @findings.each do |finding| %>
					<tr><td><%= finding.experiment.exp_type %></td>
					<td><%= finding.experiment.paper.year %></td>
					<td>Finding: <%= finding.finding %></b><br>
					Task: <% finding.tasks.each do |task| %>
						<%= task.task_tag %>
					<% end %><br>
					Components of immersion: <% finding.comps.each do |comp| %>
						<%= comp.comp_tag %>, 
					<% end %><br>
					Metrics: <% finding.metrics.each do |metric| %>
						<%= metric.metric_tag %>, 
					<% end %><br>
					Systems: <% finding.systems.each do |system| %>
						<%= system.system_tag %>, 
					<% end %><br></td></tr>
				<% end %>
			</table>
		</div>
		
		<div id="search_experiments" style="display:<% if @display_as == 'Experiments' %>inline<% else %>none<% end %>">
			<center><small>Display results as:</small><br>
			<%= link_to 'Findings', "#", :onclick => "search_results_display_as('findings')" %> | Experiments | <%= link_to 'Papers', "#", :onclick => "search_results_display_as('papers')" %></center>
			<h1>Results:</h1>
			
			<table cellspacing="0" cellpadding="0">
				<tr><th style="width:15%">Experiment Type</th>
				<th style="width:15%">Year</th>
				<th style="width:70%">Details</th></tr>
				<% @experiments.each do |exp| %>
					<tr><td><%= exp.exp_type %></td>
					<td><%= exp.paper.year %></td>
					<td>Experiment: <%= exp.title %></b><br>
					Task: <% exp.tasks.each do |task| %>
						<%= task.task_tag %>
					<% end %><br>
					Components of immersion: <% exp.comps.each do |comp| %>
						<%= comp.comp_tag %>, 
					<% end %><br>
					Metrics: <% exp.metrics.each do |metric| %>
						<%= metric.metric_tag %>, 
					<% end %><br>
					Systems: <% exp.systems.each do |system| %>
						<%= system.system_tag %>, 
					<% end %><br></td></tr>
				<% end %>
			</table>
		</div>
		
		<div id="search_papers" style="display:<% if @display_as == 'Papers' %>inline<% else %>none<% end %>">
			<center><small>Display results as:</small><br>
			<%= link_to 'Findings', "#", :onclick => "search_results_display_as('findings')" %> | <%= link_to 'Experiments', "#", :onclick => "search_results_display_as('experiments')" %>  | Papers</center>
			<h1>Results:</h1>
			
			<table cellspacing="0" cellpadding="0">
				<tr><th style="width:15%">Paper Title</th>
				<th style="width:15%">Year</th>
				<th style="width:70%">Details</th></tr>
				<% @papers.each do |paper| %>
					<tr><td><%= paper.title %></td>
					<td><%= paper.year %></td>
					<td>Paper: <%= paper.title %></b><br>
					Task(s): <% Task.joins(:experiments).where(:experiments => {:id => paper.experiments}).each do |task| %>
						<%= task.task_tag %>, 
					<% end %><br>
					Components of immersion: <% Comp.joins(:experiments).where(:experiments => {:id => paper.experiments}).each do |comp| %>
						<%= comp.comp_tag %>, 
					<% end %><br>
					Metrics: <% Metric.joins(:experiments).where(:experiments => {:id => paper.experiments}).each do |metric| %>
						<%= metric.metric_tag %>, 
					<% end %><br>
					Systems: <% System.joins(:experiments).where(:experiments => {:id => paper.experiments}).each do |system| %>
						<%= system.system_tag %>, 
					<% end %><br></td></tr>
				<% end %>
			</table>
		</div>
	</div>
</div>